<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Camera Video and Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: Arial, sans-serif;
            background: #181a1b;
            color: #e0e0e0;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .video-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #181a1b;
        }
        .video-window {
            width: 90%;
            height: 70vh;
            background: #111214;
            border-radius: 10px;
            box-shadow: 0 0 10px #000a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        canvas#video-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .fps-label-outside {
            margin-top: 10px;
            align-self: flex-end;
            margin-right: 5%;
            background: rgba(30,32,34,0.85);
            color: #fff;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 1rem;
            font-family: monospace;
            box-shadow: 0 1px 4px #0003;
        }
        .stats-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px 20px;
            background: #23272a;
            box-shadow: -2px 0 8px #0002;
            overflow-y: auto;
        }
        .stat-box {
            background: #23272a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px #0001;
        }
        .stat-box h3 {
            margin-top: 0;
            color: #e0e0e0;
        }
        .stat-box p {
            margin: 8px 0;
            color: #b0b0b0;
        }
        table {
            width: 100%;
            background: #2c2f33;
            color: #e0e0e0;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        table th, table td {
            padding: 6px;
            border-bottom: 1px solid #444;
            text-align: left;
        }
        canvas#chart {
            background: #1e1e1e;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <div class="video-window">
                <canvas id="video-canvas"></canvas>
            </div>
            <div class="fps-label-outside" id="fps-label">FPS: --</div>
        </div>
        <div class="stats-section">
            <div class="stat-box">
                <h3>Statistics</h3>
                <p><strong>Conveyor Speed:</strong> {{ conveyor_speed }} mm/s</p>
                <p><strong>Resolution:</strong> {{ resolution }}</p>
                <p><strong>FPS:</strong> <span id="fps-value">{{ fps }}</span></p>
                <p><strong>Detection interval:</strong> {{ detection_interval }}</p>
                <h3 style="margin-top:24px;">Detected Pieces - Coordinates</h3>
                <table id="pieces-table">
                    <thead>
                        <tr>
                            <th>Piece</th>
                            <th>X</th>
                            <th>Y</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data inserted via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="stat-box">
                <h3>Live Chart</h3>
                <canvas id="chart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('video-canvas');
        const ctx = canvas.getContext('2d');
        const tableBody = document.getElementById('table-body');

        const chartCtx = document.getElementById('chart').getContext('2d');
        const scatterChart = new Chart(chartCtx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Detected Pieces',
                    backgroundColor: '#4bc0c0',
                    data: []
                }]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'X (px)' }, beginAtZero: true },
                    y: { title: { display: true, text: 'Y (px)' }, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        function drawDetections(frameUrl, detections) {
            const image = new Image();
            image.onload = function () {
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 2;
                detections.forEach((det, index) => {
                    ctx.beginPath();
                    ctx.arc(det.x, det.y, det.r || 10, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.fillStyle = "#ffffff";
                    ctx.fillText(`P${index + 1}`, det.x + 5, det.y - 5);
                });
            };
            image.src = frameUrl;
        }

        async function updateDetections() {
            try {
                const res = await fetch('/api/detections');
                const data = await res.json();
                const { frame_url, detections, fps } = data;

                drawDetections(frame_url, detections);
                document.getElementById("fps-label").textContent = `FPS: ${fps}`;
                document.getElementById("fps-value").textContent = fps;

                tableBody.innerHTML = '';
                scatterChart.data.datasets[0].data = [];

                detections.forEach((det, i) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>P${i + 1}</td><td>${det.x}</td><td>${det.y}</td>`;
                    tableBody.appendChild(row);
                    scatterChart.data.datasets[0].data.push({ x: det.x, y: det.y });
                });

                scatterChart.update();
            } catch (error) {
                console.error("Error fetching detections:", error);
            }
        }

        setInterval(updateDetections, 500); // Update every 0.5s
    </script>
</body>
</html>
