<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Robot Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body, .bg-dark { background-color: #181a1b !important; }
    .card, .form-range, .log-area, .btn, .form-control {
      background-color: #23272b !important;
      color: #f8f9fa !important;
      border-color: #343a40 !important;
    }
    /* Button styles */
    .btn-info { background-color: rgb(26,104,119) !important; border-color: #0dcaf0 !important; }
    .btn-warning { background-color: #ffc107 !important; border-color: #ffc107 !important; color: #181a1b !important; }
    .btn-secondary { background-color: #6c757d !important; border-color: #6c757d !important; }
    .btn-danger { background-color: #dc3545 !important; border-color: #dc3545 !important; }
    .btn-outline-primary { border-color: #0d6efd !important; color: #0d6efd !important; }
    .btn-outline-danger { border-color: #dc3545 !important; color: #dc3545 !important; }
    .btn-outline-primary:hover, .btn-outline-primary:active { background-color: #0d6efd !important; color: #fff !important; }
    .btn-outline-danger:hover, .btn-outline-danger:active { background-color: #dc3545 !important; color: #fff !important; }
    .form-range::-webkit-slider-thumb, .form-range::-moz-range-thumb, .form-range::-ms-thumb { background: #0dcaf0; }
    label, h1, h5, .card-header { color: #f8f9fa !important; }
    .card-header { background-color: #23272b !important; border-bottom: 1px solid #343a40 !important; }
    .log-area { border-radius: 4px; }
    .calib-point { display: flex; gap: 10px; margin-bottom: 8px; }
    .calib-input { flex: 1; }
    .status-badge { min-width: 120px; }
  </style>
</head>
<body class="bg-dark">
  <div class="container py-4">
    <h1 class="mb-2">
      Robot Control 
      <span id="picoStatus" class="badge bg-success ms-2 status-badge">Pico: Connesso</span>
      <span id="calibGlobalStatus" class="badge bg-secondary ms-2 status-badge">Calib: Non calibrata</span>
    </h1>

    <!-- Settings -->
    <div class="card mb-4 bg-dark text-light">
      <div class="card-header">Settings</div>
      <div class="card-body">
      <div class="mb-2">
        <button id="btnRebootPi"   class="btn btn-info me-2 mb-2">Reboot Pi5</button>
        <button id="btnRebootPico" class="btn btn-info mb-2">Reboot Pico</button>
      </div>
      <div class="mb-2">
        <button id="btnDiscPico"   class="btn btn-secondary me-2 mb-2">Disconnect Pico</button>
        <button id="btnConnPico"   class="btn btn-secondary mb-2">Reconnect Pico</button>
      </div>
      <div>
        <button id="btnGitPull" class="btn btn-info">Pull Updates</button>
      </div>
      </div>
    </div>

    <!-- Speed Slider & Video Button -->
    <div class="mb-3 d-flex align-items-center">
      <div class="flex-grow-1">
        <label>Speed: <span id="speedVal">100%</span></label>
        <input type="range" id="speedRange" min="5" max="100" step="1" value="100" class="form-range">
      </div>
      <a href="/video" target="_blank" class="btn btn-info ms-3">Video</a>
    </div>

    <!-- Homing & Grip -->
    <div class="mb-3">
      <button id="btnHoming" class="btn btn-warning me-2">Homing</button>
      <button id="btnOpen" class="btn btn-secondary me-1">Open Grip</button>
      <button id="btnClose" class="btn btn-secondary">Close Grip</button>
    </div>

    <!-- Jog ±1mm with hold -->
    <div class="mb-3">
      <h5>Jog</h5>
      <button id="jXpos" class="btn btn-outline-primary me-1" title="hold to repeat">X +1</button>
      <button id="jYpos" class="btn btn-outline-primary me-1" title="hold to repeat">Y +1</button>
      <button id="jZpos" class="btn btn-outline-primary me-1" title="hold to repeat">Z +1</button>
      <button id="jXneg" class="btn btn-outline-danger ms-3" title="hold to repeat">X -1</button>
      <button id="jYneg" class="btn btn-outline-danger me-1" title="hold to repeat">Y -1</button>
      <button id="jZneg" class="btn btn-outline-danger" title="hold to repeat">Z -1</button>
    </div>

    <!-- Emergency & Enable Motors -->
    <div class="mb-4">
      <button id="btnStop" class="btn btn-danger me-2">STOP</button>
      <button id="btnReset" class="btn btn-warning me-2">RESET</button>
      <button id="btnEnableMotors" class="btn btn-info">Abilita Motori</button>
    </div>

    <!-- Vision Calibration -->
    <div class="card mb-4">
      <div class="card-header">Vision Calibration</div>
      <div class="card-body">
        <div class="mb-3">
          <button id="btnStartCalib" class="btn btn-info mb-2">Start Calibration</button>
          <button id="btnAddCalibPoint" class="btn btn-info mb-2">Add Calibration Point</button>
          <button id="btnCalcCalib" class="btn btn-info mb-2">Calculate Calibration</button>
          <div class="mt-2">
            <label>Calibration Status: <span id="calibStatus">Not calibrated</span></label>
            <span id="calibPoints" class="badge bg-secondary ms-2">0 points</span>
          </div>
        </div>
        
        <div id="calibPointsContainer" class="d-none mt-3">
          <h6>Calibration Points:</h6>
          <div id="pointsList" class="mt-2"></div>
        </div>
      </div>
    </div>

    <!-- Manual G-code Entry -->
    <div class="card mb-4">
      <div class="card-header">Manual G-code</div>
      <div class="card-body">
        <textarea id="gcodeInput" rows="5" class="form-control mb-2" placeholder="E.g.\nG0 X10 Y0 Z0\nG1 X0 Y10 Z0"></textarea>
        <button id="btnSendGcode" class="btn btn-outline-primary">Send G-code</button>
      </div>
    </div>

    <!-- Log -->
    <div class="card">
      <div class="card-body p-2">
        <pre id="log" class="bg-dark text-light p-2 log-area"></pre>
      </div>
    </div>
  </div>

  <!-- Main Script -->
  <script>
    const logEl = document.getElementById('log');
    function log(msg) {
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
    }
    function setUI(on) {
      document.querySelectorAll('button, input').forEach(el => el.disabled = !on);
    }

    // Pico status badge
    const statusEl = document.getElementById('picoStatus');
    const calibGlobalStatus = document.getElementById('calibGlobalStatus');
    function updatePicoStatus(){
      axios.get('/api/pico_status')
        .then(r => {
          const ok = r.data.connected;
          statusEl.textContent = ok ? 'Pico: Connesso' : 'Pico: Disconnesso';
          statusEl.className = ok ? 'badge bg-success ms-2 status-badge' : 'badge bg-danger ms-2 status-badge';
        })
        .catch(_ => {
          statusEl.textContent = 'Pico: Errore';
          statusEl.className = 'badge bg-warning ms-2 status-badge';
        });
    }
    
    // Update calibration status globally
    function updateCalibGlobalStatus() {
      axios.get('/api/get_calibration_status')
        .then(r => {
          const calibrated = r.data.calibrated;
          calibGlobalStatus.textContent = calibrated ? 'Calib: Completata' : 'Calib: Non calibrata';
          calibGlobalStatus.className = calibrated ? 'badge bg-success ms-2 status-badge' : 'badge bg-secondary ms-2 status-badge';
        });
    }
    
    updatePicoStatus();
    updateCalibGlobalStatus();
    setInterval(updatePicoStatus, 5000);
    setInterval(updateCalibGlobalStatus, 3000);

    // Speed control
    const spR = document.getElementById('speedRange'), spV = document.getElementById('speedVal');
    spR.oninput = () => { spV.textContent = spR.value + '%'; };
    spR.onchange = () => { axios.post('/api/set_speed', { speed_pct: +spR.value }); };

    // Reboot/Connect buttons
    document.getElementById('btnRebootPi').onclick = () => {
      if(confirm('Reboot Pi5?')) axios.post('/api/reboot_pi').then(r=>log('Pi5 → '+r.data.status));
    };
    document.getElementById('btnRebootPico').onclick = () => {
      if(confirm('Reboot Pico?')) axios.post('/api/reboot_pico').then(r=>log('Pico → '+r.data.status));
    };
    document.getElementById('btnDiscPico').onclick = () => { axios.post('/api/disconnect_pico').then(r=>{log('Pico → '+r.data.status); updatePicoStatus();}); };
    document.getElementById('btnConnPico').onclick = () => { axios.post('/api/reconnect_pico').then(r=>{log('Pico → '+r.data.status); updatePicoStatus();}); };
    document.getElementById('btnGitPull').onclick = () => {
      if(confirm('Git pull & restart?')) axios.post('/api/git_pull').then(r=>{log('Git → '+r.data.status); log(r.data.output);});
    };

    // Homing & Grip
    document.getElementById('btnHoming').onclick = () => axios.post('/api/homing').then(r=>log('Homing → '+r.data.status));
    document.getElementById('btnOpen').onclick   = () => axios.post('/api/upload',{commands:[{cmd:'grip',angle:0}]}).then(()=>axios.post('/api/run_queue')).then(()=>log('Grip open'));
    document.getElementById('btnClose').onclick  = () => axios.post('/api/upload',{commands:[{cmd:'grip',angle:84}]}).then(()=>axios.post('/api/run_queue')).then(()=>log('Grip close'));

    // Jog with hold
    let jogTimer;
    function startJog(ax, m){ axios.post('/api/jog',{axis:ax,mm:m}).then(r=>log(`Jog ${ax} ${m>0?'+':'-'}1 → ${r.data.status}`)); jogTimer = setTimeout(()=>startJog(ax,m), 200); }
    function stopJog(){ clearTimeout(jogTimer); }
    [['jXpos','X',1],['jYpos','Y',1],['jZpos','Z',1],
     ['jXneg','X',-1],['jYneg','Y',-1],['jZneg','Z',-1]
    ].forEach(([id,ax,m]) => {
      const btn= document.getElementById(id);
      ['mousedown','touchstart'].forEach(ev=>btn.addEventListener(ev, ()=>startJog(ax,m)));
      ['mouseup','mouseleave','touchend'].forEach(ev=>btn.addEventListener(ev, stopJog));
    });

    // Emergency & Reset & Enable Motors
    document.getElementById('btnStop').onclick = () => {
      axios.post('/api/stop').then(r=>{
      log('STOP → '+r.data.status);
      setUI(false);
      document.getElementById('btnReset').disabled = false;
      // Settings buttons remain enabled after STOP
      document.getElementById('btnGitPull').disabled = false;
      document.getElementById('btnRebootPi').disabled = false;
      document.getElementById('btnRebootPico').disabled = false;
      document.getElementById('btnDiscPico').disabled = false;
      document.getElementById('btnConnPico').disabled = false;
      });
    };
    document.getElementById('btnReset').onclick = () => {
      axios.post('/api/reset').then(r=>{ log('RESET → '+r.data.status); setUI(true); document.getElementById('btnEnableMotors').disabled=true; });
    };
    document.getElementById('btnEnableMotors').onclick = () => {
      axios.post('/api/enable_motors').then(r=>{ log('Motori abilitati → '+r.data.status); document.getElementById('btnEnableMotors').disabled=true; });
    };

    // Send G-code
    document.getElementById('btnSendGcode').onclick = () => {
      const code = document.getElementById('gcodeInput').value.trim();
      if(!code) return log('Nessun G-code da inviare');
      axios.post('/api/gcode',{ code }).then(r=>log(`Movimenti inviati: ${r.data.sent}`));
    };

    // Vision Calibration
    let calibPoints = [];
    const calibStatus = document.getElementById('calibStatus');
    const calibPointsBadge = document.getElementById('calibPoints');
    const pointsList = document.getElementById('pointsList');
    const calibContainer = document.getElementById('calibPointsContainer');
    
    // Start new calibration
    document.getElementById('btnStartCalib').onclick = () => {
      axios.post('/api/start_calibration')
        .then(r => {
          calibPoints = [];
          updateCalibUI();
          calibStatus.textContent = 'Attivo - posiziona il robot';
          log('Calibrazione avviata: ' + r.data.message);
          updateCalibGlobalStatus();
        })
        .catch(err => log('Errore avvio calibrazione: ' + err.message));
    };
    
    // Add calibration point
    document.getElementById('btnAddCalibPoint').onclick = () => {
      // 1. Ottieni posizione corrente del robot
      axios.get('/api/get_current_position')
        .then(posRes => {
          if(posRes.data.status !== 'ok') throw new Error('Posizione robot non disponibile');
          
          // 2. Ottieni rilevazioni dalla camera
          axios.get('/api/detections')
            .then(detRes => {
              const detections = detRes.data.detections;
              if(!detections || detections.length === 0) throw new Error('Nessun oggetto rilevato');
              
              // 3. Trova l'oggetto più vicino al centro
              const centerX = 320; // Centro orizzontale per 640px
              const centerY = 240; // Centro verticale per 480px
              
              let closest = null;
              let minDistance = Infinity;
              
              for(const obj of detections) {
                const dist = Math.sqrt(
                  Math.pow(obj.x - centerX, 2) + 
                  Math.pow(obj.y - centerY, 2)
                );
                
                if(dist < minDistance) {
                  minDistance = dist;
                  closest = obj;
                }
              }
              
              if(!closest) throw new Error('Nessun oggetto valido trovato');
              
              // 4. Invia punto al backend
              axios.post('/api/add_calibration_point', {
                img_x: closest.x,
                img_y: closest.y,
                robot_x: posRes.data.position.BASE,
                robot_y: posRes.data.position.M1
              })
              .then(r => {
                // Aggiorna UI con nuovo punto
                calibPoints.push({
                  imgX: r.data.img_x,
                  imgY: r.data.img_y,
                  robotX: r.data.robot_x,
                  robotY: r.data.robot_y
                });
                
                updateCalibUI();
                log(`Punto calibrazione aggiunto: Img(${r.data.img_x},${r.data.img_y}) → Robot(${r.data.robot_x},${r.data.robot_y})`);
                calibPointsBadge.textContent = `${calibPoints.length} punti`;
                calibStatus.textContent = `Punti: ${calibPoints.length}`;
              })
              .catch(err => log('Errore aggiunta punto: ' + err.message));
            })
            .catch(err => log('Errore rilevazioni: ' + err.message));
        })
        .catch(err => log('Errore posizione: ' + err.message));
    };
    
    // Calculate calibration matrix
    document.getElementById('btnCalcCalib').onclick = () => {
      if(calibPoints.length < 3) {
        log('Errore: Almeno 3 punti richiesti per la calibrazione');
        return;
      }
      
      axios.post('/api/calculate_calibration')
        .then(response => {
          if(response.data.status === 'calibration_complete') {
            calibStatus.textContent = 'Calibrato!';
            log('Calibrazione completata con successo!');
            log('Matrice: ' + JSON.stringify(response.data.matrix));
            updateCalibGlobalStatus();
          } else {
            log('Errore calibrazione: ' + response.data.error);
          }
        })
        .catch(error => {
          log('Errore calcolo calibrazione: ' + error.message);
        });
    };
    
    // Update calibration UI
    function updateCalibUI() {
      calibPointsBadge.textContent = `${calibPoints.length} punti`;
      
      if(calibPoints.length > 0) {
        calibContainer.classList.remove('d-none');
        pointsList.innerHTML = '';
        
        calibPoints.forEach((point, index) => {
          const pointEl = document.createElement('div');
          pointEl.className = 'calib-point mb-2';
          pointEl.innerHTML = `
            <span class="badge bg-info align-self-center">${index + 1}</span>
            <input type="text" class="form-control calib-input" 
                   value="Immagine: (${point.imgX.toFixed(1)}, ${point.imgY.toFixed(1)})" readonly>
            <span class="align-self-center">→</span>
            <input type="text" class="form-control calib-input" 
                   value="Robot: (${point.robotX.toFixed(1)}, ${point.robotY.toFixed(1)})" readonly>
          `;
          pointsList.appendChild(pointEl);
        });
      } else {
        calibContainer.classList.add('d-none');
      }
    }

    // initialize UI
    setUI(true);
    updateCalibUI();
  </script>
</body>
</html>