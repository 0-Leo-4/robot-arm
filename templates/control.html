<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Robot Control</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body, .bg-dark {
      background-color: #181a1b !important;
    }
    .card, .form-range, .log-area, .btn, .form-control {
      background-color: #23272b !important;
      color: #f8f9fa !important;
      border-color: #343a40 !important;
    }
    .btn-info, .btn-warning, .btn-secondary, .btn-outline-primary, .btn-outline-danger, .btn-danger {
      color: #f8f9fa !important;
    }
    .btn-info { background-color:rgb(26, 104, 119) !important; border-color: #0dcaf0 !important; }
    .btn-warning { background-color: #ffc107 !important; border-color: #ffc107 !important; color: #181a1b !important;}
    .btn-secondary { background-color: #6c757d !important; border-color: #6c757d !important; }
    .btn-danger { background-color: #dc3545 !important; border-color: #dc3545 !important; }
    .btn-outline-primary { border-color: #0d6efd !important; color: #0d6efd !important; }
    .btn-outline-danger { border-color: #dc3545 !important; color: #dc3545 !important; }
    .btn-outline-primary:hover, .btn-outline-primary:active { background-color: #0d6efd !important; color: #fff !important; }
    .btn-outline-danger:hover, .btn-outline-danger:active { background-color: #dc3545 !important; color: #fff !important; }
    .form-range::-webkit-slider-thumb { background: #0dcaf0; }
    .form-range::-moz-range-thumb { background: #0dcaf0; }
    .form-range::-ms-thumb { background: #0dcaf0; }
    label, h1, h5, .card-header { color: #f8f9fa !important; }
    .card-header { background-color: #23272b !important; border-bottom: 1px solid #343a40 !important; }
    .log-area { border-radius: 4px; }
  </style>
</head>
<body class="bg-dark">
  <div class="container py-4">
    <h1 class="mb-2">Robot Control 
    <span id="picoStatus" class="badge bg-success ms-2">Pico: Connesso</span>
  </h1>

    <!-- Settings -->
    <div class="card mb-4 bg-dark text-light">
      <div class="card-header">Settings</div>
      <div class="card-body">
      <div class="mb-2">
        <button id="btnRebootPi"   class="btn btn-info me-2 mb-2">Reboot Pi5</button>
        <button id="btnRebootPico" class="btn btn-info mb-2">Reboot Pico</button>
      </div>
      <div class="mb-2">
        <button id="btnDiscPico"   class="btn btn-secondary me-2 mb-2">Disconnect Pico</button>
        <button id="btnConnPico"   class="btn btn-secondary mb-2">Reconnect Pico</button>
      </div>
      <div>
        <button id="btnGitPull" class="btn btn-info">Pull Updates</button>
      </div>
      </div>
    </div>

    <!-- Speed Slider & Video Button -->
    <div class="mb-3 d-flex align-items-center">
      <div class="flex-grow-1">
      <label>Speed: <span id="speedVal">100%</span></label>
      <input type="range" id="speedRange" min="5" max="100" step="5" value="100" class="form-range">
      </div>
      <a href="/video" target="_blank" class="btn btn-info ms-3">Video</a>
    </div>

    <!-- Homing & Grip -->
    <div class="mb-3">
      <button id="btnHoming" class="btn btn-warning me-2">Homing</button>
      <button id="btnOpen"  class="btn btn-secondary me-1">Open Grip</button>
      <button id="btnClose" class="btn btn-secondary">Close Grip</button>
    </div>

    <!-- Jog ±1mm with hold -->
    <div class="mb-3">
      <h5>Jog</h5>
      <button class="btn btn-outline-primary me-1" id="jXpos" title="hold to repeat">X +1</button>
      <button class="btn btn-outline-primary me-1" id="jYpos" title="hold to repeat">Y +1</button>
      <button class="btn btn-outline-primary me-1" id="jZpos" title="hold to repeat">Z +1</button>
      <button class="btn btn-outline-danger ms-3" id="jXneg" title="hold to repeat">X -1</button>
      <button class="btn btn-outline-danger me-1" id="jYneg" title="hold to repeat">Y -1</button>
      <button class="btn btn-outline-danger" id="jZneg" title="hold to repeat">Z -1</button>
    </div>

    <!-- Emergency -->
    <div class="mb-4">
      <button id="btnStop"  class="btn btn-danger me-2">STOP</button>
      <button id="btnReset" class="btn btn-warning">RESET</button>
    </div>

    <!-- Log -->
    <div class="card bg-dark text-light">
      <div class="card-body p-2">
        <pre id="log" class="bg-dark text-light p-2 log-area"></pre>
      </div>
    </div>
  </div>

  <script>
    const logEl  = document.getElementById('log');
    let repeatId = null;
    function log(msg){
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
    }
    function setUI(on){
      document.querySelectorAll('button, input').forEach(el=>el.disabled=!on);
    }

    // Speed
    const spR = document.getElementById('speedRange'),
          spV = document.getElementById('speedVal');
    // Aggiorna l'handler dello slider
    spR.oninput = () => {
        const v = +spR.value;
        spV.textContent = v + '%';
        currentSpeed = v;  // Mantieni una variabile globale per la velocità
        axios.post('/api/set_speed', {speed_pct: v});
    };

    // Reboot Pi5
    document.getElementById('btnRebootPi').onclick = () => {
      if (confirm("Reboot host (Pi5)?")) {
        axios.post('/api/reboot_pi')
             .then(r => log('Pi5 → ' + r.data.status))
             .catch(err => log('Error reboot Pi5: ' + err));
      }
    };

    // Reboot Pico
    document.getElementById('btnRebootPico').onclick = () => {
      if (confirm("Reboot Pico?")) {
        axios.post('/api/reboot_pico')
             .then(r => log('Pico → ' + r.data.status))
             .catch(err => log('Error reboot Pico: ' + err));
      }
    };

    // Homing
    document.getElementById('btnHoming').onclick = () => {
      axios.post('/api/homing')
        .then(r => log('Homing → ' + r.data.status))
        .catch(e => log('Error: ' + e));
    };

    // Gripper
    document.getElementById('btnOpen').onclick = () => {
      axios.post('/api/upload',{commands:[{cmd:'grip',angle:0}]})
        .then(()=> axios.post('/api/run_queue'))
        .then(r=>log('Grip open'))
        .catch(e=>log('Error: '+e));
    };
    document.getElementById('btnClose').onclick = () => {
      axios.post('/api/upload',{commands:[{cmd:'grip',angle:84}]})
        .then(()=> axios.post('/api/run_queue'))
        .then(r=>log('Grip close'))
        .catch(e=>log('Error: '+e));
    };

    // Jog helper
    function startJog(a, m){
        axios.post('/api/jog', {
            axis: a,
            jog: m,  // Invia come parametro jog invece di mm
            speed_pct: currentSpeed  // Aggiungi parametro velocità
        })
        .then(r => log(`Jog ${a} ${m>0?'+':'-'}1 → ${r.data.status}`))
        .catch(e => log('Error: '+e));
        repeatId = setTimeout(() => startJog(a, m), 200);
    }
    function stopJog(){ clearTimeout(repeatId); repeatId = null; }

    // Attach hold listeners
    [['jXpos','X',1],['jXneg','X',-1],
     ['jYpos','Y',1],['jYneg','Y',-1],
     ['jZpos','Z',1],['jZneg','Z',-1]
    ].forEach(([id,ax,m]) => {
      const btn = document.getElementById(id);
      btn.onmousedown = () => startJog(ax,m);
      btn.onmouseup   = () => stopJog();
      btn.onmouseleave= () => stopJog();
      btn.ontouchstart= () => startJog(ax,m);
      btn.ontouchend  = () => stopJog();
    });

    // Emergency
    document.getElementById('btnStop').onclick = () => {
      axios.post('/api/stop')
      .then(r => { 
        log('STOP → ' + r.data.status); 
        setUI(false); 
        document.getElementById('btnReset').disabled = false;
      })
      .catch(e => log('Error: '+e));
    };
    document.getElementById('btnReset').onclick = () => {
      axios.post('/api/reset')
        .then(r => { log('RESET → ' + r.data.status); setUI(true); })
        .catch(e => log('Error: '+e));
    };

    // Disconnect Pico
    document.getElementById('btnDiscPico').onclick = () => {
      axios.post('/api/disconnect_pico')
        .then(r => log('Pico → ' + r.data.status))
        .catch(e => log('Error: ' + e));
    };

    // Reconnect Pico
    document.getElementById('btnConnPico').onclick = () => {
      axios.post('/api/reconnect_pico')
        .then(r => log('Pico → ' + r.data.status))
        .catch(e => log('Error: ' + e));
    };

    // Aggiorna badge di stato Pico
    const statusEl = document.getElementById('picoStatus');
    function updatePicoStatus(){
      axios.get('/api/pico_status')
        .then(r => {
          const ok = r.data.connected;
          statusEl.textContent = ok ? 'Pico: Connesso' : 'Pico: Disconnesso';
          statusEl.className = ok ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';
        })
        .catch(_ => {
          statusEl.textContent = 'Pico: Errore';
          statusEl.className = 'badge bg-warning ms-2';
        });
    }
    // Richiama subito e poi ogni 5 secondi
    updatePicoStatus();
    setInterval(updatePicoStatus, 1000);

    // Quando fai disconnect/reconnect aggiorna subito
    document.getElementById('btnDiscPico').onclick = () => {
      axios.post('/api/disconnect_pico')
        .then(r => { log('Pico → '+r.data.status); updatePicoStatus(); })
        .catch(e => log('Error: '+e));
    };
    document.getElementById('btnConnPico').onclick = () => {
      axios.post('/api/reconnect_pico')
        .then(r => { log('Pico → '+r.data.status); updatePicoStatus(); })
        .catch(e => log('Error: '+e));
    };

    // Pull updates da Git
    document.getElementById('btnGitPull').onclick = () => {
      if (confirm("Eseguire git pull e riavviare l’app?")) {
        axios.post('/api/git_pull')
          .then(r => {
            log('Git Pull → ' + r.data.status);
            log(r.data.output);
            // qui eventualmente riavvii il server o mostri istruzioni
          })
          .catch(e => log('Error git pull: ' + e));
      }
    };
    setUI(true);
  </script>
</body>
</html>
